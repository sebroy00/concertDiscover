<!DOCTYPE html>
<html>
<header>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/main.css">
</header>

<body>
   <br>
    <form class="form-horizontal">
       <div class="form-group">
           <label for="inputEmail3" class="col-sm-2 control-label">Playlist(s)</label>
           <div class="col-sm-5">
            <select class="form-control" id="playlist_select">
               <option value="volvo">All</option>
                <option value="volvo">Discover Weekly</option>
                <option value="saab">Jazz</option>
                <option value="mercedes">Fusion</option>
                <option value="audi">Funk</option>
            </select>
           </div>
       </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">Radius</label>
            <div class="col-sm-5">
               <div class="input-group">
                <input type="number" class="form-control" id="inputRadius" placeholder="100">
                <span class="input-group-addon">km</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="inputPassword3" class="col-sm-2 control-label">Location</label>
            <div class="col-sm-5">
                <input type="text" class="form-control" id="inputLocation" placeholder="Ottawa">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-5">
                <div class="checkbox">
                    <label>
                        <input type="checkbox"> Include top songs
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-5">
                <div class="checkbox">
                    <label>
                        <input type="checkbox"> Include top artists
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-5">
                <button class="btn btn-default" onclick="lookupConcerts()">Search concerts</button>
            </div>
        </div>
    </form>
    <div class="col-md-12">
       <h2>Results</h2>
        <div class="media">
           <div class="pull-right">
                <img class="media-object pull-right" width="150" src="" id="{{id}}2"/>
            </div>
            <div class="media-body">
                <dl class="dl-horizontal">
                    <dt><span class="pull-left" id="{{id}}1">1</span>Artist</dt>
                    <dd class="clearfix">{{id}}</dd>
                    <dt>City</dt>
                    <dd>{{city_name}}</dd>
                    <dt>Venue</dt>
                    <dd>{{venue_name}}</dd>
                </dl>
            </div>
        </div>
    </div>
</body>
<footer>
   <script id="user-profile-template" type="text/x-handlebars-template">
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
            </div>
            <div class="media-body">
                <dl class="dl-horizontal">
                    <dt>Display name</dt>
                    <dd class="clearfix">{{display_name}}</dd>
                    <dt>Id</dt>
                    <dd>{{id}}</dd>
                    <dt>Country</dt>
                    <dd>{{country}}</dd>
                </dl>
            </div>
        </div>
    </script>
    <script type="text/javascript" src="http://api.eventful.com/js/api"></script>
    <script>        
        (function () {
            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                userProfileTemplate = Handlebars.compile(userProfileSource),
                userProfilePlaceholder = document.getElementById('user-profile');

            var albumProfileSource = document.getElementById('album-template').innerHTML,
                albumProfileTemplate = Handlebars.compile(albumProfileSource),
                albumPlaceHolder = document.getElementById('album');

            /*user data*/
            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;
            var user_id = '';

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                            user_id = response.id;
                            $('#login').hide();
                            $('#loggedin').show();
                        }
                    });
                    /*logged in*/
                    getUserPlayLists();
                } else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }
            }
        
        /*for dropdown*/
        function getUserPlayLists() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me/playlists/',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function (response) {
                    var a = 0
                    while (response.items[a++] != null) {
                        //alert(response.items[a].name);
                        if (response.items[a].name == "Discover Weekly") {
                            getArtistsFromPlaylist(response.items[a].id, 'spotifydiscover');
                        }
                        else{
                            getArtistsFromPlaylist(response.items[a].id, 'spotify');
                        }
                    }
                }
            });
        }
        /*-----*/
            
        function lookupConcerts(){
            var playlist = $("#playlist_select").find(":selected").text();
            var radius = $("#inputRadius").val();
            var location = $("#inputLocation").val();
        }
        
        function getPlaylistAlbums(playlist, radius, location){
            $.ajax({
                    url: 'https://api.spotify.com/v1/me/playlists/',
                    headers: {
                        'Authorization': 'Bearer ' + access_token;
                    },
                    success: function (response) {
                        var a = 0
                        while (response.items[a++] != null) {
                            if (response.items[a].name == playlist) {
                                getArtistsFromPlaylist(response.items[a].id, 'spotify');
                            }
                        }
                    }
            });
        }
        
        function getArtistsFromPlaylist(playlist_id, playlist_origin) {
            $.ajax({
                url: 'https://api.spotify.com/v1/users/'+ playlist_origin +'/playlists/' + playlist_id,
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function (response) {
                    var i = 0;
                    while (response.tracks.items[i] != null) {
                        albumPlaceHolder.innerHTML += albumProfileTemplate(response.tracks.items[i].track);
                        $("#" + response.tracks.items[i].track.id + "2").attr("src", response.tracks.items[i].track.album.images[0].url);
                        eventful_api_call('Ottawa', response.tracks.items[i].track.artists[0].name, 'Future', 200);
                        i++;
                    }
                }
            });
        }
            
        function eventful_api_call(keywords, radius, location) {
            var oArgs = {
                app_key: 'dVZ4kGxHCr6QMvS9',
                q: "music",
                where: location,
                sort_order: "popularity",
                keywords: keywords,
                /*date: date,*/
                within: radius
            };
            EVDB.API.call("/events/search", oArgs, function (oData) {
                if(oData.events != null)
                    if(parseInt(oData.page_count) > 1)
                        alert(oData.events.event[0].city_name + ', keywords :' + keywords);
                    else
                        alert(oData.events.event.city_name + ', keywords :' + keywords);
            });
        }
            
    })();
    </script>
</footer>

</html>